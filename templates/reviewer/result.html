<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶„ì„ ê²°ê³¼ Â· Shortory</title>
  <style>
    :root{
      /* Base */
      --ink:#1d1f21; --muted:#5b6068; --bg:#ffffff; --border:#eceff3;
      --r:18px; --shadow:0 20px 60px rgba(15,23,42,.12);

      /* Mint palette (main.html í†¤) */
      --mint-50:#F4F2EF;
      --mint-300:#DAFEA4;
      --mint-400:#BFF08A;
      --sky-300:#94B6EF;
      --sky-200:#BDE6FF;

      --accent:var(--mint-300);
      --accent-600:var(--mint-400);

      /* Page gradient */
      --grad-page:
        radial-gradient(1200px 600px at 20% -10%, rgba(218,254,164,.45), transparent 60%),
        radial-gradient(900px 500px at 85% 10%, rgba(148,182,239,.35), transparent 60%),
        linear-gradient(180deg,#ffffff 0%,#f8fafc 40%,#f6f7f9 100%);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
      color:var(--ink); background:var(--grad-page); min-height:100vh;
      display:flex; flex-direction:column;
    }

    /* Header */
    .site-header{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 28px; background:rgba(255,255,255,.8);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--border);
    }
    .brand{font-weight:1000; letter-spacing:-.02em; text-decoration:none; color:#2a3a2f; font-size:22px}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#fff; color:#0f172a; text-decoration:none; font-weight:900;
      transition:transform .06s ease, background .15s ease, box-shadow .15s ease;
      cursor:pointer;
    }
    .btn:hover{background:#f8fafc; transform:translateY(-1px)}
    .btn.primary{background:var(--accent); border-color:transparent; color:#0b1220; box-shadow:0 10px 30px rgba(75,132,255,.16)}
    .btn.primary:hover{background:var(--accent-600)}

    /* Container */
    .container{max-width:1120px; margin:28px auto; padding:0 16px;}

    /* Page hero */
    .page-hero{
      display:flex; align-items:center; justify-content:space-between; gap:20px;
      border:1px solid rgba(255,255,255,.7);
      background:rgba(255,255,255,.75); backdrop-filter:blur(8px);
      border-radius:22px; padding:16px 20px; box-shadow:var(--shadow);
    }
    .page-hero .sub{ display:flex; flex-direction:column; gap:2px; }
    .left{display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      border:1px solid var(--border);
      background:linear-gradient(180deg,#fff,#f8fafc);
      font-size:.9rem; color:#334155; font-weight:700;
    }
    .title{font-size:clamp(20px,2.8vw,28px); font-weight:700; letter-spacing:-.02em}
    .sub{color:var(--muted); font-size:.96rem; font-weight:700}

    .meta-inline{color:#334155; font-weight:600}

    /* Grid of result clips (ì¡°ê¸ˆ ë” í° íƒ€ì¼) */
    .clips{
      margin-top:18px;
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
    @media (max-width:640px){
      .clips{grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));}
    }

    .card{
      border:1px solid rgba(255,255,255,.7);
      background:rgba(255,255,255,.9);
      border-radius:18px; padding:12px; box-shadow:var(--shadow);
      backdrop-filter:blur(8px);
      transition:transform .08s ease, box-shadow .15s ease;
      text-align:center;
    }
    .card:hover{ transform:translateY(-2px); box-shadow:0 18px 40px rgba(15,23,42,.12); }

    .select-row{
      display:flex; align-items:center; justify-content:center; gap:8px;
      margin-bottom:8px; color:#1B3444; font-weight:800; font-size:.92rem;
    }
    .select-row input[type="checkbox"]{ transform:scale(1.15); cursor:pointer }

    .thumb{
      position:relative; width:100%; border-radius:14px; overflow:hidden; background:#000;
      aspect-ratio:9/16;
      box-shadow:0 8px 22px rgba(15,23,42,.18);
      margin:0 auto 8px;
    }
    .thumb video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block}

    .emotion{font-weight:900; color:#1B3444; margin-top:4px}
    .timestamp{font-size:.85rem; color:#333; margin-top:2px}
    .filename{font-size:.78rem; color:#555; margin-top:4px}

    .btn-save{
      margin-top:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:#0f172a; font-weight:900; cursor:pointer;
      transition:background .15s ease, transform .06s ease;
    }
    .btn-save:hover:not(:disabled){ background:#f8fafc; transform:translateY(-1px) }
    .btn-save:disabled{ background:#e5e7eb; color:#9ca3af; cursor:default }

    /* Action row */
    .actions{
      display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;
      margin:22px 0 8px;
    }
    .hint{ text-align:center; color:#1B3444; font-weight:700; margin-top:6px }

    /* Empty state */
    .empty{
      margin-top:18px; text-align:center;
      border:1px solid rgba(255,255,255,.7);
      background:rgba(255,255,255,.86);
      border-radius:22px; padding:28px; box-shadow:var(--shadow);
      color:var(--muted); font-weight:700;
    }

    /* Footer */
    .footer{ text-align:center; color:#9aa3ad; font-size:.9rem; margin:24px 0 10px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <a class="brand" href="/">Shortory</a>
    <a class="btn" href="{{ url_for('reviewer.dashboard') }}">â† ëŒ€ì‹œë³´ë“œë¡œ</a>
  </header>

  <main class="container">
    <!-- post_id ì•ˆì „ ì „ë‹¬ -->
    <div id="page-meta" data-post-id="{{ post_id }}"></div>

    <!-- Hero -->
    <section class="page-hero">
  <div class="left">
    <span class="badge">RESULT Â· CLIPS</span>
    <div>
      <div class="title">ğŸ“‹ ë¶„ì„ ê²°ê³¼</div>

      <!-- ë¬¸ì¥ë³„ ì¤„ë°”ê¿ˆ -->
      <div class="sub">
        {% if videos %}
          <div>ì´ <span class="meta-inline">{{ videos|length }}</span>ê°œì˜ ìˆí¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        {% else %}
          <div>ì•„ì§ ìƒì„±ëœ ìˆí¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        {% endif %}

        {% if elapsed_time %}
          <div>ì†Œìš” ì‹œê°„: <span class="meta-inline">{{ elapsed_time }}</span></div>
        {% endif %}
      </div>
    </div>
  </div>

  <a class="btn primary hero-cta" href="{{ url_for('result.categories_view') }}">
    ğŸ“‚ ë³´ê´€í•¨
  </a>
</section>


    {% if videos %}
      <!-- Clips grid -->
      <section class="clips">
        {% for video in videos %}
          <article class="card">
            <!-- ì œì¶œ ì„ íƒ -->
            <div class="select-row">
              <input
                type="checkbox"
                name="clip_ids"
                value="{{ video['id'] }}"
                id="clip_{{ loop.index }}"
              />
              <label for="clip_{{ loop.index }}">í¬ë¦¬ì—ì´í„°ì—ê²Œ ì œì¶œ</label>
            </div>

            <div class="thumb">
              <video controls autoplay muted loop preload="metadata">
                <source src="{{ url_for('static', filename='shorts_output/' ~ task_id ~ '/' ~ video['filename']) }}" type="video/mp4">
                ë¸Œë¼ìš°ì €ê°€ video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
              </video>
            </div>

            <div class="emotion">{{ video['emotion'] }}</div>
            <div class="timestamp">ì˜ìƒ ì‹œì : {{ video['timestamp'] }}</div>
            <div class="filename">{{ video['filename'] }}</div>

            <!-- ê°œì¸ ë³´ê´€í•¨ ì €ì¥ -->
            <button
              class="btn-save"
              data-filename="{{ video['filename'].split('/')[-1] }}"
              data-emotion="{{ video['emotion'] }}"
              data-task-id="{{ task_id }}"
            >ë³´ê´€í•¨ì— ì €ì¥</button>
          </article>
        {% endfor %}
      </section>

      <!-- ì œì¶œ/íƒìƒ‰ ì•¡ì…˜ -->
      <div class="actions">
        <button id="submit-to-creator" class="btn primary">ì„ íƒí•œ í´ë¦½ í¬ë¦¬ì—ì´í„°ì—ê²Œ ì œì¶œ</button>
        <a href="{{ url_for('result.categories_view') }}" class="btn">ğŸ“‚ ì €ì¥ëœ í´ë¦½ ë³´ê´€í•¨ ë³´ê¸°</a>
        <a href="{{ url_for('reviewer.dashboard') }}" class="btn">ğŸ”™ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
      <div class="hint">â€» ìµœì†Œ 1ê°œ, ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

    {% else %}
      <div class="empty">
        ì•„ì§ ìƒì„±ëœ ìˆí¼ì´ ì—†ìŠµë‹ˆë‹¤.
        <div style="margin-top:10px;">
          <a href="{{ url_for('result.categories_view') }}" class="btn">ğŸ“‚ ì €ì¥ëœ í´ë¦½ ë³´ê´€í•¨ ë³´ê¸°</a>
          <a href="{{ url_for('reviewer.dashboard') }}" class="btn" style="margin-left:6px;">ğŸ”™ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
      </div>
    {% endif %}

    <div class="footer">Â© 2025 ì°°ë‚˜ì˜ Shortory</div>
  </main>

  <!-- ë³´ê´€í•¨ ì €ì¥ ìŠ¤í¬ë¦½íŠ¸ (ê¸°ì¡´ ìœ ì§€) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const saveButtons = document.querySelectorAll('.btn-save');

      saveButtons.forEach(function (button) {
        button.addEventListener('click', function () {
          if (button.disabled) return;

          const filename = button.getAttribute('data-filename');
          const emotion  = button.getAttribute('data-emotion');
          const taskId   = button.getAttribute('data-task-id');

          fetch('{{ url_for("result.save_clip") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, emotion, task_id: taskId })
          })
          .then(r => r.json())
          .then(data => {
            if (data.status === 'success') {
              button.textContent = 'ì €ì¥ë¨';
              button.disabled = true;
            } else {
              alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\\n' + (data.message || ''));
            }
          })
          .catch(() => alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'));
        });
      });
    });
  </script>

  <!-- ì„ íƒ ì œì¶œ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    function getPostId() {
      const el = document.getElementById('page-meta');
      if (el && el.dataset.postId) return el.dataset.postId;
      const qs = new URLSearchParams(location.search).get('post_id');
      return qs || null;
    }

    const submitBtn = document.getElementById('submit-to-creator');
    if (submitBtn) {
      submitBtn.addEventListener('click', async () => {
        const checked = Array.from(document.querySelectorAll('input[name="clip_ids"]:checked')).map(el => el.value);
        if (checked.length < 1 || checked.length > 3) {
          alert('ìµœì†Œ 1ê°œ, ìµœëŒ€ 3ê°œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        const postId = getPostId();
        if (!postId) {
          alert('post_idê°€ í…œí”Œë¦¿ìœ¼ë¡œ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }

        try {
          const res  = await fetch(`/reviewer/submit_result/${postId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ selected_ids: checked })
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.msg || 'ì œì¶œ ì‹¤íŒ¨');
          alert('ì œì¶œ ì™„ë£Œ! í¬ë¦¬ì—ì´í„°ì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) {
          alert(e.message);
        }
      });
    }

    // ìµœëŒ€ 3ê°œ ì œí•œ
    document.querySelectorAll('input[name="clip_ids"]').forEach(cb => {
      cb.addEventListener('change', () => {
        const checked = document.querySelectorAll('input[name="clip_ids"]:checked');
        if (checked.length > 3) {
          cb.checked = false;
          alert('ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
      });
    });
  </script>
</body>
</html>
